<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/frag_head :: HeadFragment}"></th:block>
    <link href="/css/inquiry.css" rel="stylesheet" />
    <!-- í™”ë©´ ìº¡ì³ CDN -->
    <script src="/js/html2canvas.min.js"></script>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="d-flex flex-column h-100">
<main class="flex-shrink-0">
    <!-- Navigation-->
    <th:block th:replace="~{fragments/frag_nav :: NavFragment(userId=${userId})}"></th:block>
    <input type="hidden" id="userId" th:value="${userId}">
    <!-- Page Content-->
    <div class="container px-3 my-5">
        <div class="text-center mb-5">
            <h1 class="display-6 fw-bolder mb-0"><span class="d-inline">ì‚¬ì§„ ì´¬ì˜ ë° ë…¹ìŒ</span></h1>
        </div>
        <div class="row gx-2 justify-content-center">
            <div class="col-lg-11 col-xl-10 col-xxl-9">
                <section>
                    <div class="card shadow border-0 rounded-4 mb-5">
                        <div class="card-body">
                            <div class="alert alert-primary alert-dismissible fade show d-flex flex-wrap align-items-center" role="alert">
                                <span class="me-2">ì¼ì¼ ì½˜í…ì¸  ìƒì„± ê°€ëŠ¥ íšŸìˆ˜: [[${remainingAttempts}]]íšŒ</span>
                                <a class="upgrade-btn me-auto mt-2 mt-sm-0" href="/pages/plan/payment">ì—…ê·¸ë ˆì´ë“œ</a>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            <div class="text-center my-5">
                                <p class="lead mb-4">ì‚¬ìš©ìì˜ í˜„ì¬ í‘œì •ì„ ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•©ë‹ˆë‹¤.</p>
                                <p class="text-muted">í‘œì •ì„ ë¶„ì„í•˜ì—¬ ê°ì •ì„ ìœ ì¶”í•©ë‹ˆë‹¤.</p>
                            </div>
                            <!-- ì›¹ìº  ì˜ì—­ -->
                            <div style="width: 100%" class="d-flex justify-content-center align-items-center mb-3">
                                <div class="border p-3 col-12 col-sm-10 col-md-8 col-lg-6">
                                    <video id="CameraView" poster="/static/assets/default_profile.png" style="width: 100%; height: 100%; object-fit: contain;"></video>
                                </div>
                            </div>
                            <!-- ì¹´ë©”ë¼ On/off ë²„íŠ¼ -->
                            <div class="text-center mb-3">
                                <button id="openBtn" class="btn btn-outline-primary">ì¹´ë©”ë¼ ì¼œê¸°</button>
                                <button id="closeBtn" class="btn btn-outline-primary">ì¹´ë©”ë¼ ë„ê¸°</button>
                            </div>
                            <!-- ì‚¬ì§„ ì´¬ì˜ ë²„íŠ¼ -->
                            <div class="text-center mb-5">
                                <button id="takePhoto" class="btn btn-outline-primary" onclick="takePhoto()"><i class="bi bi-camera-fill"></i>ì‚¬ì§„ ì´¬ì˜</button>
                            </div>
                            <!-- ì‚¬ì§„ ì´¬ì˜ ê²°ê³¼ ì¶œë ¥ -->
                            <div style="width: 100%" class="d-flex justify-content-center align-items-center mb-3">
                                <div id="capture_result" class="border p-3 col-12 col-sm-10 col-md-8 col-lg-6 hidden"></div>
                            </div>
                            <div class="text-center mb-5 hidden" id="re_takePhoto_div">
                                <button id="re_takePhoto" class="btn btn-outline-primary" onclick="re_takePhoto()">ë‹¤ì‹œ ì°ê¸°</button>
                            </div>

                            <hr>

                            <div class="text-center my-5">
                                <p class="lead mb-4">ì‚¬ìš©ìì˜ ëª©ì†Œë¦¬ë¥¼ ë§ˆì´í¬ë¡œ ë…¹ìŒí•©ë‹ˆë‹¤.</p>
                                <p class="text-muted">ëª©ì†Œë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°ì •ì„ ìœ ì¶”í•©ë‹ˆë‹¤.</p>
                            </div>

                            <!-- ìŒì„± ë…¹ìŒ ë²„íŠ¼ -->
                            <div class="text-center mb-5">
                                <button id="recordBtn" class="btn btn-outline-primary"><i class="bi bi-mic-fill"></i> ë…¹ìŒ ì‹œì‘</button>
                                <span id="timer"></span>
                            </div>

                            <!-- ìŒì„± ë…¹ìŒ ê²°ê³¼ ì¬ìƒ -->
                            <div class="text-center mb-5">
                                <div id="audioContainer" style="margin-top: 20px;"></div>
                            </div>

                            <!-- ì½˜í…ì¸  ìƒì„± ë° ë‹¤ì‹œ ì°ê¸° ë²„íŠ¼ -->
                            <div class="text-center mt-5 mb-3">
                                <button id="sendPhoto" class="btn btn-primary btn-lg" onclick="sendUserFile()">ì½˜í…ì¸  ìƒì„±</button>
                            </div>
                            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ ì˜ì—­ -->
                            <div class="d-flex justify-content-center" id="loadingSpinner">
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</main>
<!-- Footer ì˜ì—­ fragment -->
<th:block th:replace="~{fragments/frag_footer :: FooterFragment}"></th:block>
<!-- script ì˜ì—­ fragment -->
<th:block th:replace="~{fragments/frag_script :: ScriptFragment}"></th:block>
<script th:inline="javascript">
    // ì„œë²„ë¡œ ì „ì†¡í•  formData. ì´ê³³ì— ì´ë¯¸ì§€ì™€ ìŒì„± íŒŒì¼ì´ append ë¨
    const formData = new FormData();

    let streamVideo

    // ì¹´ë©”ë¼ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸
    let cameraOn = false;

    // ì‚¬ì§„ ì°ì—ˆëŠ”ì§€ í™•ì¸
    let takePhoto_ck = false;

    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia )
    {
        alert("Media Device not supported")
    } else {
        document.getElementById("openBtn").addEventListener('click',open)
        document.getElementById("closeBtn").addEventListener('click',close)
        open()
    }

    // ì¹´ë©”ë¼ ì¼œê¸°
    function open() {
        close()
        navigator.mediaDevices.getUserMedia({video:true}).then(stream => {
            cameraOn = true;
            streamVideo = stream
            let cameraView = document.getElementById("CameraView");
            cameraView.srcObject = stream;
            cameraView.play()
        })
    }

    // ì¹´ë©”ë¼ ë„ê¸°
    function close() {
        if (streamVideo) {
            cameraOn = false;
            let track = streamVideo.getTracks()
            track[0].stop()
            streamVideo = null
        }
    }

    // ì‚¬ì§„ ì´¬ì˜
    function takePhoto(){
        if(!cameraOn){
            alert("ì¹´ë©”ë¼ë¥¼ ì¼œì£¼ì„¸ìš”");
        }
        else{
            takePhoto_ck = true;
            // ì‚¬ì§„ ìº¡ì³í•œ í›„ì— div íƒœê·¸ì— ì¶œë ¥í•˜ê¸°
            html2canvas(document.querySelector("#CameraView")).then(canvas => {
                document.getElementById('capture_result').style.display = 'block';
                document.getElementById('re_takePhoto_div').style.display = 'block';
                document.querySelector("#capture_result").appendChild(canvas)
                let capture_result = document.getElementById("capture_result")
                capture_result.scrollIntoView({behavior : 'smooth'})
            });

        }
    }

    // ì‚¬ì§„ ë‹¤ì‹œ ì°ê¸°
    function re_takePhoto(){
        takePhoto_ck = false;
        // ê¸°ì¡´ì— ì°ì—ˆë˜ ì‚¬ì§„ì„ í™”ë©´ì—ì„œ ì§€ìš°ê¸°
        document.getElementById('capture_result').innerHTML = '';
        document.getElementById('capture_result').style.display = 'none';
        document.getElementById('re_takePhoto_div').style.display = 'none';

        // ì›¹ìº  ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
        let CameraView = document.getElementById("CameraView")
        CameraView.scrollIntoView({behavior : 'smooth'})
    }

    // ìŒì„± ë…¹ìŒ
    const recordBtn = document.getElementById('recordBtn');
    const audioContainer = document.getElementById('audioContainer');
    const timerEl = document.getElementById('timer');

    let mediaRecorder;
    let audioChunks = [];
    let countdownInterval;

    // ìŒì„± ë…¹ìŒ ì—¬ë¶€
    let recordVoice = false;

    // ì˜¤ë””ì˜¤ ì €ì¥ìš© blob
    let audioBlob = null;


    recordBtn.addEventListener('click', async () => {
        recordVoice = false; // ìƒˆ ë…¹ìŒ ì‹œì‘í•  ë•Œ ì´ˆê¸°í™”
        recordBtn.disabled = true;
        //recordBtn.textContent = 'ë…¹ìŒ ì¤‘...';

        recordBtn.innerHTML = "<div class=\"spinner-border\" role=\"status\">\n" +
            "                                    <span class=\"visually-hidden\">Loading...</span>\n" +
            "                                </div>\n" +
            "                                <span class=\"ms-2\">\n" +
            "    ë…¹ìŒ ì¤‘...<br>\n" +
            "</span>";

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                // ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ true ë¡œ ì„¤ì •
                recordVoice = true;
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl;

                audioContainer.innerHTML = '';
                audioContainer.appendChild(audio);

                recordBtn.disabled = false;
                recordBtn.textContent = 'ğŸ™ï¸ ë…¹ìŒ ë‹¤ì‹œ ì‹œì‘';
                timerEl.textContent = '';
                clearInterval(countdownInterval);
            };

            mediaRecorder.start();

            // íƒ€ì´ë¨¸ í‘œì‹œ
            let timeLeft = 8;
            timerEl.textContent = `(${timeLeft}ì´ˆ ë‚¨ìŒ)`;
            countdownInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `(${timeLeft}ì´ˆ ë‚¨ìŒ)`;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    mediaRecorder.stop();
                }
            }, 1000);
        } catch (err) {
            alert('ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            console.error(err);
            recordBtn.disabled = false;
            recordBtn.textContent = 'ğŸ™ï¸ ë…¹ìŒ ì‹œì‘';
            timerEl.textContent = '';
        }
    });

    // ì„œë²„ë¡œ ì´ë¯¸ì§€, ìŒì„± íŒŒì¼ ì „ì†¡
    function sendUserFile() {
        if(!takePhoto_ck){
            alert("ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”");
            let CameraView = document.getElementById("CameraView")
            CameraView.scrollIntoView({behavior : 'smooth'})
            return;
        }

        if (!recordVoice) {
            alert("ìŒì„± ë…¹ìŒì„ ì™„ë£Œí•´ì£¼ì„¸ìš”");
            let recordBtn = document.getElementById("recordBtn")
            recordBtn.scrollIntoView({behavior : 'smooth'})
            return;
        }

        if (!audioBlob) {
            alert("ë…¹ìŒëœ ì˜¤ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤");
            return;
        }

        /*<![CDATA[*/
        // ì¼ì¼ ì½˜í…ì¸  ìƒì„± ê°€ëŠ¥ íšŸìˆ˜
        let remainingAttempts = /*[[${remainingAttempts}]]*/;
        if(remainingAttempts < 1){
            alert("ì¼ì¼ ì½˜í…ì¸  ìƒì„± ê°€ëŠ¥ íšŸìˆ˜ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.\ní”Œëœì„ ì—…ê·¸ë ˆì´ë“œ í•˜ê±°ë‚˜ ë‹¤ìŒë‚  ì´ìš©í•´ì£¼ì„¸ìš”.");
            return;
        }
        /*]]>*/

        // #capture_result div ì—ì„œ ìº¡ì³ëœ canvas ìš”ì†Œ ì°¾ê¸°
        const canvas = document.querySelector("#capture_result canvas");

        if (canvas) {
            // ìº¡ì³ëœ ì´ë¯¸ì§€ë¥¼ Blob ìœ¼ë¡œ ë³€í™˜
            canvas.toBlob(function(blob) {
                // Blob ë°ì´í„°ë¥¼ FormData ì— ì²¨ë¶€
                formData.append("UserImage", blob, "captured-image.png");

                // ì˜¤ë””ì˜¤ blob ë°ì´í„°ë„ í¼ë°ì´í„°ì— ì²¨ë¶€
                formData.append('UserAudio', audioBlob, 'record-voice.webm');

                // ì½˜í…ì¸  ìƒì„±ì„ ìš”ì²­í•œ ìœ ì €ì˜ ID ì²¨ë¶€
                let userId = $('#userId').val();
                formData.append('userId', userId);

                const spinner = document.getElementById("loadingSpinner");

                spinner.innerHTML = "<div class=\"spinner-border\" role=\"status\">\n" +
                    "                                    <span class=\"visually-hidden\">Loading...</span>\n" +
                    "                                </div>\n" +
                    "                                <span class=\"ms-2\">\n" +
                    "    ì½˜í…ì¸  ìƒì„± ì¤‘...<br>\n" +
                    "    (í™˜ê²½ì— ë”°ë¼ 3ë¶„~5ë¶„ ì •ë„ ì†Œìš”)\n" +
                    "</span>";

                // POST ìš”ì²­ì„ í†µí•´ ì„œë²„ë¡œ ì „ì†¡
                fetch('/UserUpload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        // ì„œë²„ì—ì„œ "ì—…ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤." ë©”ì‹œì§€ë¥¼ ë°›ì€ ê²½ìš° ì²˜ë¦¬
                        if (response.ok) {
                            return response.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
                        } else {
                            throw new Error("ìƒì„± ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    })
                    .then(message => {
                        // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¥¼ alert ë¡œ í‘œì‹œ
                        alert(message); // "ì—…ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”." ë©”ì‹œì§€ê°€ alertë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                    })
                    .catch(error => {
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ alert ë¡œ í‘œì‹œ
                        console.error('Error :', error);
                        alert('ìƒì„± ìš”ì²­ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    });
            });
        } else {
            console.error('No image to send!');
        }
    }

</script>
</body>
</html>
